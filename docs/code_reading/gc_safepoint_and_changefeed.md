# TiCDC GC Safepoint 与 Changefeed 同步机制

**TL;DR**：
- **Too Long; Didn't Read**：本文档分析 TiCDC 的 GC safepoint 管理机制和 changefeed 同步一致性
- **核心内容**：TiCDC 如何通过 GC safepoint 保护数据，changefeed 的 start-ts 机制，BR 备份恢复场景的数据一致性
- **关键结论**：
  - TiCDC 会向 PD 注册 GC safepoint，基于所有 changefeed 的最小 checkpointTs
  - **没有 changefeed 时，TiCDC 使用当前时间作为 GC safepoint（不阻塞 TiKV GC）**
  - **创建 changefeed 不指定 start-ts 会使用当前时间，增量同步场景适用，但 BR 恢复场景会导致数据丢失**
  - 如果 start-ts 小于 GC safepoint，changefeed 创建会失败（`ErrStartTsBeforeGC`）
- **适用场景**：理解 TiCDC 数据保护机制、规划数据同步策略、BR 备份恢复 + TiCDC 联合使用
- **阅读建议**：按目录阅读，重点关注 GC safepoint 更新机制和 BR 恢复场景

---

目录:
- [A. GC Safepoint 机制概述](#a-gc-safepoint-overview)
  - [1 TiKV GC 机制](#sec-a1-tikv-gc)
  - [2 TiCDC GC Safepoint 管理](#sec-a2-ticdc-gc)
  - [3 没有 changefeed 时的行为](#sec-a3-no-changefeed)
- [B. Changefeed 同步机制](#b-changefeed-sync)
  - [1 start-ts 的作用](#sec-b1-start-ts)
  - [2 创建 changefeed 时的 GC 检查](#sec-b2-gc-check)
  - [3 同步模式对比](#sec-b3-sync-modes)
- [C. BR 备份恢复场景](#c-br-restore)
  - [1 正确的同步流程](#sec-c1-correct-flow)
  - [2 常见错误场景](#sec-c2-common-errors)
  - [3 数据丢失风险分析](#sec-c3-data-loss)
  - [4 最佳实践](#sec-c4-best-practices)
- [D. 术语汇总小节](#d-terminology)

---

<a id="a-gc-safepoint-overview"></a>
## A. GC Safepoint 机制概述

summary：
- **文档范围**
    - 解释 TiKV 的 GC 机制和 TiCDC 如何通过 GC safepoint 保护数据。
- **核心机制**
    - TiKV 基于 GC safepoint 清理旧数据。
    - TiCDC 向 PD 注册 service GC safepoint，阻止 TiKV GC 未同步的数据。
    - GC safepoint = 所有 changefeed 的最小 checkpointTs。
- **关键结论**
    - 没有 changefeed 时，TiCDC 使用当前时间作为 GC safepoint，不阻塞 TiKV GC。
    - 有 changefeed 时，GC safepoint 由最慢的 changefeed 决定。

---

<a id="sec-a1-tikv-gc"></a>
### 1 TiKV GC 机制

TiKV 使用 GC（Garbage Collection）机制清理旧版本数据，释放存储空间。

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              TiKV GC 机制                                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   TiDB/TiKV 集群                                                                            │
│   │                                                                                         │
│   ├── TiDB                                                                                  │
│   │   └── tidb_gc_life_time 参数（默认 10 分钟）                                             │
│   │       • 控制数据保留时间                                                                 │
│   │       • 超过此时间的数据可以被 GC                                                        │
│   │                                                                                         │
│   ├── PD（Placement Driver）                                                                │
│   │   └── GC safepoint 管理                                                                 │
│   │       • 收集所有 service GC safepoint                                                   │
│   │       • 计算全局 GC safepoint = min(所有 service safepoint)                              │
│   │       • 通知 TiKV 执行 GC                                                               │
│   │                                                                                         │
│   └── TiKV                                                                                  │
│       └── 执行 GC                                                                           │
│           • 删除 < GC safepoint 的数据                                                      │
│           • 压缩存储空间                                                                    │
│                                                                                             │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   Service GC Safepoint 示例：                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   Service ID                Safepoint                                               │   │
│   │   ─────────────────────────────────────────────                                      │   │
│   │   gc_worker                 100                                                      │   │
│   │   ticdc                     80   ← TiCDC 注册的 safepoint（最小）                      │   │
│   │   backup                    90                                                       │   │
│   │   ─────────────────────────────────────────────                                      │   │
│   │   全局 GC safepoint         80   ← min(所有 service safepoint)                        │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

**关键参数**：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `tidb_gc_life_time` | 10m | TiDB 数据保留时间 |
| `tidb_gc_safe_point` | - | 当前 GC safepoint（只读） |
| TiCDC `gc-ttl` | 24h | TiCDC service safepoint TTL |

---

<a id="sec-a2-ticdc-gc"></a>
### 2 TiCDC GC Safepoint 管理

TiCDC 作为 PD 的一个 service，会向 PD 注册 GC safepoint，保护未同步的数据不被 GC。

#### 2.1 GC Safepoint 计算逻辑

```golang
// coordinator/changefeed/changefeed_db.go:307-325
// CalculateGlobalGCSafepoint 计算所有 changefeed 的最小 checkpointTs
func (db *ChangefeedDB) CalculateGlobalGCSafepoint() uint64 {
    var minCpts uint64 = math.MaxUint64  // ← 默认值是 MaxUint64

    for _, cf := range db.changefeeds {
        info := cf.GetInfo()
        if info == nil || !info.NeedBlockGC() {
            continue  // ← 跳过不需要阻塞 GC 的 changefeed
        }
        checkpointTs := cf.GetLastSavedCheckPointTs()
        if minCpts > checkpointTs {
            minCpts = checkpointTs  // ← 取最小值
        }
    }
    return minCpts
}
```

#### 2.2 GC Safepoint 更新逻辑

```golang
// coordinator/coordinator.go:429-442
func (c *coordinator) updateGlobalGcSafepoint(ctx context.Context) error {
    minCheckpointTs := c.controller.calculateGlobalGCSafepoint()

    // check if the upstream has a changefeed, if not we should update the gc safepoint
    if minCheckpointTs == math.MaxUint64 {
        ts := c.pdClock.CurrentTime()
        minCheckpointTs = oracle.GoTimeToTS(ts)  // ← 没有 changefeed 时使用当前时间
    }

    // GC safepoint 的上界是 checkpointTs - 1
    gcSafepointUpperBound := minCheckpointTs - 1
    err := c.gcManager.TryUpdateServiceGCSafepoint(ctx, gcSafepointUpperBound)
    return errors.Trace(err)
}
```

#### 2.3 更新时机

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              GC Safepoint 更新时机                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   Coordinator（Owner）定期执行：                                                             │
│   ──────────────────────────────                                                            │
│   1. 每 tick（默认 1 秒）执行一次                                                            │
│   2. 计算所有 changefeed 的最小 checkpointTs                                                 │
│   3. 向 PD 更新 TiCDC 的 service GC safepoint                                               │
│   4. PD 计算全局 GC safepoint = min(所有 service safepoint)                                  │
│                                                                                             │
│   代码路径：                                                                                 │
│   coordinator/coordinator.go:215-218                                                        │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  // BeginGCTick must happen before updateGCSafepoint so tasks added in this tick    │   │
│   │  // can be completed within one gc-ttl.                                              │   │
│   │  err := c.updateGCSafepoint(ctx)                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="sec-a3-no-changefeed"></a>
### 3 没有 changefeed 时的行为

**关键结论**：没有 changefeed 时，TiCDC 使用当前时间作为 GC safepoint，**不阻塞** TiKV 的正常 GC。

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              没有 changefeed 时的 GC Safepoint                               │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   场景 1：TiCDC 启动，但没有 changefeed                                                      │
│   ────────────────────────────────────                                                      │
│   CalculateGlobalGCSafepoint() → MaxUint64                                                  │
│   updateGlobalGcSafepoint() → 使用当前时间                                                   │
│   结果：TiCDC 的 GC safepoint = 当前时间                                                     │
│         全局 GC safepoint 由其他 service 决定（如 gc_worker）                                │
│         TiKV 正常执行 GC                                                                    │
│                                                                                             │
│   场景 2：所有 changefeed 都不需要阻塞 GC（finished/stopped/failed）                         │
│   ────────────────────────────────────────────────────────────────────────                  │
│   CalculateGlobalGCSafepoint() → MaxUint64（没有 NeedBlockGC 的 changefeed）                 │
│   结果：同场景 1                                                                            │
│                                                                                             │
│   场景 3：有正在运行的 changefeed                                                            │
│   ─────────────────────────────────                                                         │
│   CalculateGlobalGCSafepoint() → min(所有 checkpointTs)                                     │
│   结果：TiCDC 的 GC safepoint = 最慢 changefeed 的 checkpointTs                              │
│         阻止 TiKV GC 这个时间点之前的数据                                                    │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

**代码证据**：

```golang
// coordinator/coordinator.go:432-435
if minCheckpointTs == math.MaxUint64 {
    ts := c.pdClock.CurrentTime()
    minCheckpointTs = oracle.GoTimeToTS(ts)  // ← 使用当前时间，不阻塞 GC
}
```

---

<a id="b-changefeed-sync"></a>
## B. Changefeed 同步机制

summary：
- **文档范围**
    - 解释 changefeed 的 start-ts 机制和 GC 检查逻辑。
- **核心机制**
    - start-ts 决定 changefeed 从哪个时间点开始同步。
    - 创建 changefeed 时会检查 start-ts 是否在 GC safepoint 之后。
- **关键结论**
    - 不指定 start-ts 时使用当前时间，只同步增量数据。
    - start-ts < GC safepoint 时会报错，changefeed 创建失败。
    - **BR 恢复场景必须指定正确的 start-ts，否则会丢失数据**。

---

<a id="sec-b1-start-ts"></a>
### 1 start-ts 的作用

`start-ts` 决定 changefeed 从哪个时间点开始同步数据。

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              start-ts 的作用                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   时间线：                                                                                   │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│   │            │                               │                                            │
│   │   T0       │   T1                          │   T2 (当前)                                │
│   │   数据     │   start-ts                    │   创建 changefeed                          │
│   │   开始     │                               │                                            │
│   │            │                               │                                            │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   同步范围：                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   T0 ───────────────────── T1 ───────────────────────────────────── T2              │   │
│   │   │                          │                                      │               │   │
│   │   │   已有数据（不同步）       │   从 start-ts 开始同步的数据         │   新数据      │   │
│   │   │                          │   ←─────────────────────────────────→│               │   │
│   │   │                          │   这些数据会被同步                    │               │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
│   不指定 start-ts 时：                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   T0 ───────────────────────────────────────────────────────────── T2              │   │
│   │   │                                                                │               │   │
│   │   │   已有数据（全部不同步）                                          │   从当前时间   │   │
│   │   │   ⚠️ 这些数据不会被同步                                          │   开始同步     │   │
│   │   │                                                                │               │   │
│   │   ──────────────────────────────────────────────────────────────────────────────── │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

**start-ts 的来源**：

| 场景 | start-ts 来源 | 说明 |
|------|--------------|------|
| 不指定 | 当前时间（PD 获取） | 只同步增量数据 |
| 手动指定 | CLI/API 参数 | 从指定时间点开始 |
| 断点恢复 | 上次 checkpointTs | 从上次中断位置继续 |

---

<a id="sec-b2-gc-check"></a>
### 2 创建 changefeed 时的 GC 检查

创建 changefeed 时，TiCDC 会检查 start-ts 是否有效（是否在 GC safepoint 之后）。

```golang
// pkg/txnutil/gc/gc_service.go:40-75
// EnsureChangefeedStartTsSafety 检查 start-ts 是否有效
func EnsureChangefeedStartTsSafety(
    ctx context.Context, pdCli pd.Client,
    gcServiceIDPrefix string,
    keyspaceID uint32,
    changefeedID common.ChangeFeedID,
    TTL int64, startTs uint64,
) error {
    gcServiceID := gcServiceIDPrefix + changefeedID.Keyspace() + "_" + changefeedID.Name()

    // 设置 service GC safepoint 为 start-ts
    minServiceGCTs, err := SetServiceGCSafepoint(ctx, pdCli, gcServiceID, TTL, startTs)
    if err != nil {
        return errors.Trace(err)
    }

    // 检查 start-ts 是否在 GC safepoint 之后
    // startTs should be greater than or equal to minServiceGCTs + 1
    if startTs > 0 && startTs < minServiceGCTs+1 {
        return errors.ErrStartTsBeforeGC.GenWithStackByArgs(startTs, minServiceGCTs)
        // ← 报错：start-ts 已经被 GC
    }
    return nil
}
```

**检查逻辑**：

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              changefeed 创建时的 GC 检查                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   检查条件：start-ts >= GC safepoint + 1                                                    │
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   GC safepoint        start-ts                                                      │   │
│   │   │                   │                                                             │   │
│   │   ▼                   ▼                                                             │   │
│   │   ├───────────────────┼────────────────────────────────────────────────────────►    │   │
│   │   │   已被 GC         │   有效数据                                                   │   │
│   │   │   无法同步        │   可以同步                                                   │   │
│   │   │                   │                                                             │   │
│   │   │                   │                                                             │   │
│   │   ▼                   ▼                                                             │   │
│   │   ✗ 创建失败          ✓ 创建成功                                                    │   │
│   │   ErrStartTsBeforeGC                                                                │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="sec-b3-sync-modes"></a>
### 3 同步模式对比

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              同步模式对比                                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   模式 1：增量同步（不指定 start-ts）                                                        │
│   ─────────────────────────────────────                                                      │
│   • start-ts = 当前时间                                                                    │
│   • 只同步 changefeed 创建后的数据                                                          │
│   • 适用场景：新业务，不需要历史数据                                                          │
│   • ⚠️ 不适用 BR 恢复场景                                                                   │
│                                                                                             │
│   模式 2：全量 + 增量同步（指定 start-ts）                                                   │
│   ───────────────────────────────────────────                                                │
│   • start-ts = 指定的时间点                                                                │
│   • 同步 start-ts 之后的所有数据                                                            │
│   • 适用场景：数据迁移、BR 恢复后同步                                                        │
│   • 前提：start-ts > GC safepoint                                                          │
│                                                                                             │
│   模式 3：断点恢复                                                                          │
│   ─────────────────                                                                         │
│   • start-ts = 上次的 checkpointTs                                                         │
│   • 从上次中断的位置继续                                                                    │
│   • 自动处理，无需手动指定                                                                   │
│                                                                                             │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   CLI 命令示例：                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   # 增量同步（不指定 start-ts）                                                       │   │
│   │   cdc cli changefeed create --sink-uri="mysql://..."                                │   │
│   │                                                                                     │   │
│   │   # 全量 + 增量同步（指定 start-ts）                                                  │   │
│   │   cdc cli changefeed create --start-ts=1234567890 --sink-uri="mysql://..."          │   │
│   │                                                                                     │   │
│   │   # BR 恢复场景（指定备份点 ts）                                                      │   │
│   │   cdc cli changefeed create --start-ts=<BackupTS> --sink-uri="mysql://..."          │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="c-br-restore"></a>
## C. BR 备份恢复场景

summary：
- **文档范围**
    - 分析 BR 备份恢复 + TiCDC 同步的正确流程和常见错误。
- **核心问题**
    - BR 恢复后如果不指定 start-ts，会从当前时间开始同步，导致数据丢失。
    - 如果数据已被 GC，changefeed 创建会失败。
- **关键结论**
    - BR 恢复后必须指定正确的 start-ts（备份点的 ts）。
    - 需要在数据被 GC 之前创建 changefeed。
    - 最佳实践：BR 备份前调大 GC 时间。

---

<a id="sec-c1-correct-flow"></a>
### 1 正确的同步流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              BR 备份恢复 + TiCDC 同步正确流程                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   时间线：                                                                                   │
│   ────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                             │
│   T0              T1              T2                    T3                T4                 │
│   │               │               │                     │                 │                  │
│   │  调大 GC      │   BR 备份     │   BR 恢复到下游      │  创建           │  同步正常        │
│   │  时间         │   记录 ts     │                     │  changefeed     │  运行中          │
│   │               │               │                     │  (指定 start-ts)│                  │
│   │               │               │                     │                 │                  │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   详细步骤：                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   Step 1: T0 - 调大 GC 时间（推荐）                                                   │   │
│   │   ────────────────────────────────                                                   │   │
│   │   SET GLOBAL tidb_gc_life_time = '24h';                                              │   │
│   │   • 延长数据保留时间，为 BR 和 TiCDC 创建争取时间                                     │   │
│   │                                                                                     │   │
│   │   Step 2: T1 - BR 备份上游                                                           │   │
│   │   ────────────────────────                                                           │   │
│   │   br backup full --pd="..." --storage="..."                                          │   │
│   │   • 记录输出的 BackupTS（例如：1234567890）                                          │   │
│   │                                                                                     │   │
│   │   Step 3: T2 - BR 恢复到下游                                                         │   │
│   │   ────────────────────────────                                                       │   │
│   │   br restore full --pd="..." --storage="..."                                         │   │
│   │   • 下游恢复到 BackupTS 的状态                                                       │   │
│   │                                                                                     │   │
│   │   Step 4: T3 - 创建 TiCDC changefeed（关键！）                                        │   │
│   │   ──────────────────────────────────────────                                          │   │
│   │   cdc cli changefeed create \                                                       │   │
│   │       --start-ts=<BackupTS> \                                                       │   │
│   │       --sink-uri="mysql://downstream:3306/"                                         │   │
│   │   • ⚠️ 必须指定 --start-ts=<BackupTS>                                               │   │
│   │   • 这样才能从备份点继续同步                                                         │   │
│   │                                                                                     │   │
│   │   Step 5: T4 - 确认同步正常后恢复 GC 时间                                             │   │
│   │   ────────────────────────────────────────                                            │   │
│   │   SET GLOBAL tidb_gc_life_time = '10m';                                              │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="sec-c2-common-errors"></a>
### 2 常见错误场景

#### 错误 1：不指定 start-ts

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              错误场景 1：不指定 start-ts                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   时间线：                                                                                   │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   T1              T2                    T3                                                  │
│   │               │                     │                                                   │
│   │   BR 备份     │   BR 恢复到下游      │   创建 changefeed（未指定 start-ts）              │
│   │   BackupTS    │                     │   start-ts = 当前时间 = T3                        │
│   │               │                     │                                                   │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   数据范围分析：                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   T1 ──────────────────────────────────────────────────────────────── T3            │   │
│   │   │                                                                   │              │   │
│   │   │   T1 ~ T3 之间的数据                                              │   从 T3 开始  │   │
│   │   │   ⚠️ 这些数据不会被同步！                                          │   同步        │   │
│   │   │   上游有，下游没有                                                 │              │   │
│   │   │   数据丢失！                                                       │              │   │
│   │   │                                                                   │              │   │
│   │   └───────────────────────────────────────────────────────────────────┘              │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
│   结果：数据不一致！T1 ~ T3 之间的数据丢失。                                                 │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 错误 2：start-ts 已被 GC

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              错误场景 2：start-ts 已被 GC                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   时间线：                                                                                   │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   T1              T2                    T3                    T4                             │
│   │               │                     │                     │                              │
│   │   BR 备份     │   BR 恢复到下游      │   数据被 GC          │   创建 changefeed            │
│   │   BackupTS    │                     │   (超过 gc_life_time)│   --start-ts=BackupTS        │
│   │               │                     │                     │                              │
│   ──────────────────────────────────────────────────────────────────────────────────────    │
│                                                                                             │
│   创建 changefeed 时的检查：                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   GC safepoint (T3)     BackupTS (T1)                                               │   │
│   │   │                      │                                                          │   │
│   │   ▼                      ▼                                                          │   │
│   │   ├──────────────────────┼────────────────────────────────────────────────────►     │   │
│   │   │   已被 GC            │   BackupTS < GC safepoint                                │   │
│   │   │                      │   ⚠️ 无法同步                                             │   │
│   │   │                      │                                                          │   │
│   │   │                      │                                                          │   │
│   │   ▼                      ▼                                                          │   │
│   │   创建失败：ErrStartTsBeforeGC                                                      │   │
│   │   "start-ts 1234567890 is earlier than or equal to GC safepoint at 1234567900"     │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
│   结果：changefeed 创建失败，需要重新 BR 备份恢复。                                          │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="sec-c3-data-loss"></a>
### 3 数据丢失风险分析

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              数据丢失风险分析                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   风险等级矩阵：                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │                              指定正确 start-ts      不指定 start-ts                  │   │
│   │   ─────────────────────────────────────────────────────────────────────────────    │   │
│   │   数据未被 GC        ✓ 数据完整，正常同步          ✗ 数据丢失（T1~T3）               │   │
│   │                                                                                     │   │
│   │   数据已被 GC        ✗ 创建失败                    ✗ 创建失败                       │   │
│   │                       （需要重新 BR）               （需要重新 BR）                   │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
│   关键结论：                                                                                 │
│   ────────────────────────────────────────────────────────────────────────────────────────  │
│   1. 不指定 start-ts = 只同步增量数据 = BR 恢复场景必然丢数据                                │
│   2. 数据被 GC = changefeed 创建失败（不会静默丢失数据）                                     │
│   3. 正确指定 start-ts + 数据未被 GC = 数据完整                                             │
│                                                                                             │
│   ⚠️ 特别注意：                                                                              │
│   不指定 start-ts 不会报错，但会导致数据丢失！这是静默错误，难以发现。                        │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="sec-c4-best-practices"></a>
### 4 最佳实践

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              BR + TiCDC 数据一致性最佳实践                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   1. BR 备份前，调大 GC 时间                                                                 │
│      ────────────────────────────                                                            │
│      SET GLOBAL tidb_gc_life_time = '24h';  -- 延长到 24 小时                               │
│      • 目的：为 BR 备份、恢复、创建 changefeed 争取时间                                      │
│                                                                                             │
│   2. BR 备份时记录 BackupTS                                                                  │
│      ────────────────────────                                                                │
│      br backup full ... 2>&1 | tee backup.log                                              │
│      • 输出中会包含 BackupTS（例如：[2024-01-01 10:00:00] BackupTS=1234567890）             │
│                                                                                             │
│   3. BR 恢复到下游                                                                           │
│      ─────────────────                                                                       │
│      br restore full --pd="downstream-pd:2379" --storage="..."                             │
│                                                                                             │
│   4. 立即创建 TiCDC changefeed（指定 start-ts）                                              │
│      ──────────────────────────────────────────                                              │
│      cdc cli changefeed create \                                                           │
│          --pd="upstream-pd:2379" \                                                         │
│          --start-ts=<BackupTS> \     -- ⚠️ 必须指定                                        │
│          --sink-uri="mysql://downstream:3306/"                                             │
│                                                                                             │
│   5. 验证数据一致性                                                                          │
│      ─────────────────                                                                       │
│      • 检查 changefeed 状态：cdc cli changefeed list                                        │
│      • 对比上下游数据：使用 sync-diff-inspector                                             │
│                                                                                             │
│   6. 确认同步正常后，恢复 GC 时间                                                            │
│      ────────────────────────────────                                                        │
│      SET GLOBAL tidb_gc_life_time = '10m';  -- 恢复默认                                     │
│                                                                                             │
│   ────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                             │
│   CLI 命令速查：                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │   # 查看 GC 相关信息                                                                 │   │
│   │   mysql> SHOW VARIABLES LIKE 'tidb_gc_life_time';                                   │   │
│   │   mysql> SELECT VARIABLE_NAME, VARIABLE_VALUE FROM mysql.tidb                       │   │
│   │          WHERE VARIABLE_NAME = 'tikv_gc_safe_point';                                │   │
│   │                                                                                     │   │
│   │   # 查看当前 PD 的 GC safepoint                                                      │   │
│   │   pd-ctl -u=http://pd:2379 service-gc-safepoint                                     │   │
│   │                                                                                     │   │
│   │   # 创建 changefeed（指定 start-ts）                                                 │   │
│   │   cdc cli changefeed create --start-ts=1234567890 --sink-uri="mysql://..."          │   │
│   │                                                                                     │   │
│   │   # 查看 changefeed 状态                                                             │   │
│   │   cdc cli changefeed list                                                           │   │
│   │   cdc cli changefeed query --changefeed-id=<ID>                                     │   │
│   │                                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

<a id="d-terminology"></a>
## D. 术语汇总小节

- **GC (Garbage Collection)**：TiKV 的数据清理机制，删除旧版本数据以释放存储空间。
    - 由 TiDB 的 `tidb_gc_life_time` 参数控制数据保留时间（默认 10 分钟）。

- **GC Safepoint**：GC 的安全点，表示此时间点之前的数据可以被安全清理。
    - TiKV 只会删除 `commit-ts < GC safepoint` 的数据。
    - PD 负责计算全局 GC safepoint = min(所有 service safepoint)。

- **Service GC Safepoint**：各服务（如 TiCDC、BR）向 PD 注册的 GC safepoint。
    - TiCDC 注册的 service safepoint = 所有 changefeed 的最小 checkpointTs。
    - 用于保护未同步的数据不被 GC。

- **start-ts**：changefeed 开始同步的时间点。
    - 不指定时使用当前时间（增量同步）。
    - 指定后从该时间点开始同步（全量 + 增量）。
    - 必须大于 GC safepoint，否则创建失败。

- **checkpointTs**：changefeed 已同步的时间点。
    - TiCDC 定期持久化 checkpointTs。
    - 用于断点恢复和计算 GC safepoint。

- **ErrStartTsBeforeGC**：创建 changefeed 时的错误，表示 start-ts 已经被 GC。
    - 需要重新进行 BR 备份恢复。

- **BackupTS**：BR 备份时的时间戳。
    - 表示备份包含的最新数据的时间点。
    - BR 恢复后，创建 TiCDC changefeed 时应使用此 ts 作为 start-ts。
